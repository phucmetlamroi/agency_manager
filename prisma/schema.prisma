generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  nickname  String?  // Display Name
  email     String?  // Optional, contact email
  phoneNumber String? // Contact phone

  password  String
  plainPassword String? // For Admin visibility
  role      String   @default("USER") // "ADMIN" or "USER"
  reputation Int     @default(100)
  isTreasurer Boolean @default(false) // Admin Role: Treasurer (Thủ quỹ)
  createdAt DateTime @default(now())
  
  tasks     Task[]
  bonuses   MonthlyBonus[]
  metrics   PerformanceMetric[]
  schedules UserSchedule[]
  focusTasks FocusTask[]
}

model Task {
  id          String   @id @default(uuid())
  title       String
  deadline    DateTime?
  value       Float    @default(0)
  isPenalized Boolean  @default(false)
  status      String   @default("Đang thực hiện") // "Đang thực hiện", "Revision", "Hoàn tất", "Tạm ngưng", "Sửa frame"
  type        String   @default("Short form") // "Trial", "Short form", "Long form"
  
  references  String?
  resources   String?  // Raw footage, B-roll
  notes       String?  // Detailed instructions
  fileLink    String?  // Backward compatibility
  productLink String?  // User submission link (Thành phẩm)
  collectFilesLink String? // New: Link to collect files
  
  
  // Financial Fields
  jobPriceUSD    Float?   @default(0) // Input: Revenue from Client (USD)
  wageVND        Float?   @default(0) // Input: Payment to Staff (VND)
  exchangeRate   Float?   @default(25300) // Stored rate at creation
  profitVND      Float?   @default(0) // Calculated: (job * rate) - wage
  
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  assigneeId  String?

  // CRM Relation
  project     Project? @relation(fields: [projectId], references: [id])
  projectId   Int?
  
  client      Client?  @relation(fields: [clientId], references: [id])
  clientId    Int?
  
  feedbacks   Feedback[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Smart Stopwatch Fields
  accumulatedSeconds Int       @default(0)
  timerStartedAt     DateTime?
  timerStatus        String    @default("PAUSED") // "RUNNING", "PAUSED", "STOPPED"
}

model Notification {
  id        String   @id @default(uuid())
  message   String
  type      String   @default("INFO") // INFO, WARNING, ERROR
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Optional: Link to User or Task for context
  userId    String?  // If null, it's a broadcast to all Admins
}

model MonthlyBonus {
  id                  String   @id @default(uuid())
  userId              String
  month               Int      // 1-12
  year                Int
  rank                Int      // 1, 2, or 3
  revenue             Float    // Snapshot of total revenue at calculation time
  executionTimeHours  Float    // Total hours spent on tasks (tie-breaker)
  bonusAmount         Float    // Calculated bonus amount (15%, 10%, or 5% of salary)
  calculatedAt        DateTime @default(now())
  
  user                User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, month, year])
}

model PayrollLock {
  id        String   @id @default(uuid())
  month     Int
  year      Int
  isLocked  Boolean  @default(false)
  lockedAt  DateTime @default(now())
  lockedBy  String   // User ID

  @@unique([month, year])
}

// ============================================
// CRM MODULE (Additive)
// ============================================

model Client {
  id            Int       @id @default(autoincrement())
  name          String
  
  // Hierarchical Relation (Parent Corporation -> Subsidiaries/Brands)
  parentId      Int?
  parent        Client?   @relation("ClientHierarchy", fields: [parentId], references: [id])
  subsidiaries  Client[]  @relation("ClientHierarchy")
  
  projects      Project[]
  tasks         Task[]
  
  // Scoring Fields (Computed by Python Cron Job)
  aiScore       Float     @default(0) // 0-100 Performance Score
  frictionIndex Float     @default(0) // How "difficult" the client is
  
  // Manual Ratings & AI Classification
  inputQuality  Int       @default(3) // 1-5
  paymentRating Int       @default(3) // 1-5
  tier          ClientTier @default(standard)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Project {
  id          Int       @id @default(autoincrement())
  name        String
  code        String?   // Internal Code e.g. "PRJ-001"
  
  client      Client    @relation(fields: [clientId], references: [id])
  clientId    Int
  
  tasks       Task[]
  feedbacks   Feedback[]
  
  createdAt   DateTime  @default(now())
}

model Feedback {
  id          Int          @id @default(autoincrement())
  content     String
  
  project     Project?     @relation(fields: [projectId], references: [id])
  projectId   Int?
  
  task        Task?        @relation(fields: [taskId], references: [id])
  taskId      String?
  
  // Type: CLIENT (External Feedback), INTERNAL (Team Review)
  type        FeedbackSource @default(CLIENT)
  severity    Int          @default(1) // 1 (Minor) -> 5 (Critical)
  
  createdAt   DateTime     @default(now())
}

enum FeedbackSource {
  INTERNAL
  CLIENT
}

enum ClientTier {
  DIAMOND
  GOLD
  SILVER
  WARNING
  standard // Default safe value
}

model PerformanceMetric {
  id                    String   @id @default(uuid())
  userId                String
  month                 Int
  year                  Int
  
  // Metrics
  revenue               Float    @default(0)
  avgCompletionTime     Int      @default(0) // Seconds
  onTimeRate            Float    @default(100) // Percentage
  
  internalRevisionCount Int      @default(0)
  clientRevisionCount   Int      @default(0)
  
  // Classification
  score                 Float    @default(0) // 0-100
  classification        String   @default("NORMAL") // POTENTIAL, NORMAL, UNDERPERFORM
  
  measuredAt            DateTime @default(now())
  
  user                  User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, month, year])
}

// ============================================
// RESOURCE SCHEDULER (Module Lịch)
// ============================================

model UserSchedule {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  startTime DateTime
  endTime   DateTime
  
  type      ScheduleType @default(BUSY)
  note      String?      // e.g., "Đi học", "Ngủ bù"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startTime]) // Fast lookup
}

enum ScheduleType {
  BUSY     // User sets: Bận, không nhận việc
  OVERTIME // User sets: Có thể nhận thêm (Yellow)
  AVAILABLE // User sets: Sẵn sàng nhận việc (Green)
  TASK     // System sets: Đang làm task
}

// Focus Note Module
model FocusTask {
  id          String   @id @default(uuid())
  content     String
  
  userId      String   
  user        User     @relation(fields: [userId], references: [id])
  
  isPriority  Boolean  @default(false)
  isDone      Boolean  @default(false)
  
  order       Int      @default(0)
  status      String   @default("DRAFT") // DRAFT, PUBLISHED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}
